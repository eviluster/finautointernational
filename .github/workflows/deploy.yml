name: Deploy via SCP

on:
  push:
    branches: [staging]

jobs:
  deploy:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ðŸ“¤ Transferir archivos al VPS
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "./"
        target: "/home/finauto/full-proyect-1"
        strip_components: 1
        
    - name: ðŸš€ Ejecutar despliegue en VPS
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script_stop: true
        script: |
          # Crear estructura de archivos crÃ­tica
          mkdir -p ~/full-proyect-1/nginx/conf
          echo "proxy_set_header Host \$host;" > ~/full-proyect-1/nginx/proxy_params
          echo "proxy_set_header X-Real-IP \$remote_addr;" >> ~/full-proyect-1/nginx/proxy_params
          echo "proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;" >> ~/full-proyect-1/nginx/proxy_params
          echo "proxy_set_header X-Forwarded-Proto \$scheme;" >> ~/full-proyect-1/nginx/proxy_params
        
          cd /home/finauto/full-proyect-1 || exit 1
          docker compose down -v --rmi all || true
          docker builder prune -af
          docker compose up -d --build || exit 1
